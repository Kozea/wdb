/*! wdb           2015-11-26 */
var Log,create_socket,get_proc_thread_val,make_brk_line,make_process_line,make_thread_line,make_uuid_line,null_if_void,rm_brk_line,rm_uuid_line,wait,ws,ws_message,indexOf=[].indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(b in this&&this[b]===a)return b;return-1};Log=function(){function a(){this.debug=$("body").attr("data-debug")||!1}return a.prototype.time=function(){var a;return a=new Date,a.getHours()+":"+a.getMinutes()+":"+(a.getSeconds()+"."+a.getMilliseconds())},a.prototype.log=function(){var a,b;return this.debug?(b="["+this.constructor.name+"] ("+this.time()+")",a=[b].concat(Array.prototype.slice.call(arguments,0)),console.log.apply(console,a)):void 0},a.prototype.fail=function(){var a,b;return b=this.constructor.name,a=[b].concat(Array.prototype.slice.call(arguments,0)),console.error.apply(console,a)},a}(),ws=null,wait=25,make_uuid_line=function(a,b){var c;return(c=$(".sessions tr[data-uuid="+a+"]")).size()||(c=$('<tr data-uuid="'+a+'"> <td class="uuid"><a href="/debug/session/'+a+'">'+a+'</a></td> <td class="socket">No</td> <td class="websocket">No</td> <td class="close"> <a class="fa fa-times-circle remove" title="Force close"></a> </td>'),$(".sessions tbody").append(c)),c.find("."+b).text("Yes")},rm_uuid_line=function(a,b){var c;if((c=$(".sessions tr[data-uuid="+a+"]")).size())return"socket"===b&&"No"===c.find(".websocket").text()||"websocket"===b&&"No"===c.find(".socket").text()?c.remove():c.find("."+b).text("No")},make_brk_line=function(a){var b,c,d,e,f;for(e="<tr>",f=["fn","lno","cond","fun"],c=0,d=f.length;d>c;c++)b=f[c],e+='<td class="'+b+'">'+(a[b]||"∅")+"</td>";return e+='<td class="action"> <a class="fa fa-folder-open open" title="Open"></a> <a class="fa fa-minus-circle remove" title="Remove"></a> </td>',e+="</tr>",$(".breakpoints tbody").append($(e))},rm_brk_line=function(a){var b,c,d,e,f,g,h,i,j,k,l;for(h=$(".breakpoints tr"),j=[],d=0,f=h.length;f>d;d++){for(l=h[d],b=$(l),k=!0,i=["fn","lno","cond","fun"],e=0,g=i.length;g>e;e++)c=i[e],k=k&&b.find("."+c).text()===""+(a[c]||"∅");k?j.push(b.remove()):j.push(void 0)}return j},get_proc_thread_val=function(a,b){var c,d,e,f,g,h,i;if(i=a[b],null==i)return"∅";if("time"===b)h=function(a){var b,c;return c=Math.floor((new Date-a)/1e3),b=Math.floor(c/31536e3),b>1?b+"y":(b=Math.floor(c/2592e3),b>1?b+"mo":(b=Math.floor(c/86400),b>1?b+"d":(b=Math.floor(c/3600),b>1?b+"h":(b=Math.floor(c/60),b>1?b+"m":Math.floor(c)+"s"))))},i=h(1e3*i);else if("mem"===b||"cpu"===b)i=i.toFixed(2)+"%";else if("cmd"===b){for(f=[],g=i.split(" "),c=0,d=g.length;d>c;c++)e=g[c],0===e.indexOf("/")?f.push('<abbr title="'+e+'">'+e.split("/").slice(-1)+"</abbr>"):1===e.indexOf(":")&&2===e.indexOf("\\")?f.push('<abbr title="'+e+'"> '+e.slice(3).split("\\").slice(-1)+"</abbr>"):f.push(e);i=f.join(" ")}return i},make_process_line=function(a){var b,c,d,e,f,g,h,i,j,k;if((b=$(".processes tbody tr[data-pid="+a.pid+"]")).size()){for(i=["pid","user","cmd","time","mem","cpu"],k=[],d=0,f=i.length;f>d;d++)c=i[d],k.push(b.find("."+c).html(get_proc_thread_val(a,c)));return k}for(h='<tr data-pid="'+a.pid+'" '+(a.threadof?'data-threadof="'+a.threadof+'"':"")+">",j=["pid","user","cmd","time","mem","cpu"],e=0,g=j.length;g>e;e++)c=j[e],h+='<td class="rowspan '+c+'"> '+get_proc_thread_val(a,c)+"</td>";return h+='<td class="action"><a href="" class="fa fa-minus minus" title="Toggle threads"></a></td>',h+='<td class="action">',h+='<a href="" class="fa fa-pause pause" title="Pause"></a> ',h+="</td>",h+="</tr>",$(".processes tbody").append($(h))},make_thread_line=function(a){var b,c,d,e,f,g,h,i,j;if(c=$(".processes tbody tr[data-pid="+a.of+"]"),c.size()){if((d=$(".processes tbody tr[data-tid="+a.id+"]")).size()){for(i=["id","of"],j=[],f=0,g=i.length;g>f;f++)e=i[f],j.push(d.find("."+e).text(get_proc_thread_val(a,e)));return j}return h='<tr data-tid="'+a.id+'" data-of="'+a.of+'">',h+='<td class="id">'+get_proc_thread_val(a,"id")+"</td>",h+='<td class="action">',h+='<a href="" class="fa fa-pause pause" title="Pause"></a> ',h+="</td>",h+="</tr>",b=c.nextAll("[data-pid]"),b.size()?b.before(h):$(".processes tbody").append(h),c.find(".rowspan").attr("rowspan",(+c.find(".rowspan").attr("rowspan")||1)+1)}},ws_message=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r;switch(wait=25,j=a.data,k=j.indexOf("|"),k>-1?(d=j.substr(0,k),e=JSON.parse(j.substr(k+1))):(d=j,e=""),d){case"AddWebSocket":return make_uuid_line(e,"websocket");case"AddSocket":return make_uuid_line(e,"socket");case"RemoveWebSocket":return rm_uuid_line(e,"websocket");case"RemoveSocket":return rm_uuid_line(e,"socket");case"AddBreak":return make_brk_line(e);case"RemoveBreak":return rm_brk_line(e);case"AddProcess":return make_process_line(e);case"AddThread":return make_thread_line(e);case"KeepProcess":for(l=$(".processes tbody tr[data-pid]"),p=[],f=0,h=l.length;h>f;f++)r=l[f],c=$(r),m=parseInt(c.attr("data-pid")),indexOf.call(e,m)<0?($(".processes [data-of="+c.attr("data-pid")+"]").remove(),p.push(c.remove())):p.push(void 0);return p;case"KeepProcess":for(n=$(".processes tbody tr[data-tid]"),q=[],g=0,i=n.length;i>g;g++)r=n[g],c=$(r),o=parseInt(c.attr("data-tid")),indexOf.call(e,o)<0?(c.remove(),b=$(".processes [data-pid="+c.attr("data-of")+"]"),q.push(b.attr("rowspan",+b.attr("rowspan")-1))):q.push(void 0);return q;case"StartLoop":return setInterval(function(){return ws.send("ListProcesses")},2e3)}},create_socket=function(){return ws=new WebSocket("ws://"+location.host+"/status"),ws.onopen=function(){return console.log("WebSocket open",arguments),$("tbody tr").remove(),ws.send("ListSockets"),ws.send("ListWebSockets"),ws.send("ListBreaks"),ws.send("ListProcesses")},ws.onerror=function(){return console.log("WebSocket error",arguments)},ws.onmessage=ws_message,ws.onclose=function(){return console.log("WebSocket closed",arguments),wait*=2,setTimeout(create_socket,wait)}},null_if_void=function(a){return"∅"===a?null:a},$(function(){return create_socket(),$(".sessions tbody").on("click",".remove",function(a){return ws.send("RemoveUUID|"+$(this).closest("tr").attr("data-uuid")),!1}),$(".breakpoints tbody").on("click",".open",function(a){var b;return b=$(this).closest("tr"),ws.send("RunFile|"+b.find(".fn").text()),!1}),$(".breakpoints tbody").on("click",".remove",function(a){var b,c;return b=$(this).closest("tr"),c={fn:b.find(".fn").text(),lno:parseInt(b.find(".lno").text()),cond:null_if_void(b.find(".cond").text()),fun:null_if_void(b.find(".fun").text())},ws.send("RemoveBreak|"+JSON.stringify(c)),!1}),$(".processes tbody").on("click",".pause",function(a){var b;return b=$(this).closest("tr"),ws.send("Pause|"+(b.attr("data-pid")||b.attr("data-tid"))),!1}).on("click",".minus",function(a){var b,c;return b=$(this),c=b.closest("tr"),$("[data-of="+c.attr("data-pid")+"]").hide(),c.find(".rowspan").attr("rowspan",1),b.attr("class",b.attr("class").replace(/minus/g,"plus")),!1}).on("click",".plus",function(a){var b,c,d;return b=$(this),c=b.closest("tr"),d=$("[data-of="+c.attr("data-pid")+"]").show().size(),c.find(".rowspan").attr("rowspan",d+1),b.attr("class",b.attr("class").replace(/plus/g,"minus")),!1}),$(".runfile").on("submit",function(){return ws.send("RunFile|"+$(this).find("[type=text]").val()),!1})});